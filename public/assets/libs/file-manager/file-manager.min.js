var getListXhr,getFileDetailsXhr;$.ajaxSetup({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}});var multiSelect=false;var caching={};var $window,detailSidebar,footer,tabs;var timers={fileDetails:{}};jQuery(function(a){if(parent.window.fileManagerModalOptions&&parent.window.fileManagerModalOptions.multi){multiSelect=true}window.fileManagerModalOptions=getValueOf(parent.window.fileManagerModalOptions?parent.window.fileManagerModalOptions:{});selectFolder(a(".breadcrumb-folders .folder").first());$window=a(window);detailSidebar=a(".media-sidebar");footer=a(".media-footer");tabs=a(".media-router .media-menu-item");a(".breadcrumb-folders li a").click(function(c){c.preventDefault();var b=a(this).closest(".folder");selectFolder(b)});$window.on("resize load",function(){var b=$window.width();if(b<=900){a(".media-folder-menu").hide();a(".media-frame-title .menu-icon").on("click",function(){a(".media-folder-menu").show()});a(".media-folder-menu .close-sidebar").on("click",function(){a(".media-folder-menu").hide()})}else{a(".media-folder-menu").show()}if(b<=768){a(".media-sidebar").hide();a(".media-sidebar .close-sidebar").on("click",function(){a(".media-sidebar").hide()})}else{a(".media-sidebar").show()}});a("#thumbnail").selectable({filter:"li:not(.unselectable)",selecting:function(d,e){var b=a(this),c=a(e.selecting);if(!multiSelect){b.find(".ui-selected").removeClass("ui-selected")}},stop:function(c,d){var b=a("li.ui-selected");if(multiSelect){showFileDetails(b.first())}else{b.not(":first").removeClass("ui-selected");b=b.first();showFileDetails(b)}refreshSelection(b)}});a("#thumbnail").find(".ui-selectee").each(function(){if(!a(this).is("li")){a(this).removeClass(".ui-selectee")}});a("#clear-list").on("click",function(){a("li.ui-selected").removeClass("active ui-selected");detailSidebar.find(".file-details").hide();footer.find(".attachments-preview").empty("active ui-selected");footer.find(".count").empty().text("گزینش شده: "+pd("0"));a("#add-btn").val("")});tabs.on("click",function(c){c.preventDefault();tabs.removeClass("active");var b=a(this).addClass("active").data("page");a(".page").hide();a("#"+b).show()});a(document).on({click:function(){let that=a(this);let file=that.closest(".file-details").attr("data-file");if(file){let data={fileKey:file};a.ajax({url:urls.deleteFile,type:"POST",data:data,beforeSend:function(){that.addClass("in-process");loadingDialog("show","#sidebar-loading")},success:function(){refreshGallery();that.removeClass("delete-file-btn");that.addClass("restore-file-btn");that.html(lang["menu-restore"]);a(".deletion-message").html(lang["message-file-deleted"]).show()},complete:function(){that.removeClass("in-process");loadingDialog("hide","#sidebar-loading")}})}}},".delete-file-btn:not(.in-process)");a(document).on({click:function(){let that=a(this);let file=that.closest(".file-details").attr("data-file");if(file){let data={fileKey:file};a.ajax({url:urls.restoreFile,type:"POST",data:data,beforeSend:function(){that.addClass("in-process");loadingDialog("show","#sidebar-loading")},success:function(){refreshGallery();that.removeClass("restore-file-btn");that.addClass("delete-file-btn");that.html(lang["menu-delete"]);a(".deletion-message").hide().html()},error:function(b){if(b.status==404){a(".deletion-message").html(lang["error-file-not-found"]).show()}},complete:function(){that.removeClass("in-process");loadingDialog("hide","#sidebar-loading")}})}}},".restore-file-btn:not(.in-process)");a(document).on({keyup:function(){updateFileDetail(a(this))},change:function(){updateFileDetail(a(this))}},".setting :input");a(document).on({click:function(b){b.preventDefault();let that=a(this);let instance=that.data("instance");let key=that.data("key");if(instance&&key){let folder=a('.folder[data-instance="'+instance+'"][data-key="'+key+'"]');if(folder.length==1){selectFolder(folder)}}}},".btn-open-folder");a(".file-list-view").scroll(function(){let scrolled=a(this).scrollTop();a("#loading-dialog").css("top",scrolled+"px")});a(".attachments-preview").on({click:function(){let that=a(this);let fileKey=that.data("file");if(fileKey){showFileDetails(a(this).closest("li"))}}},".thumbnail");a("#add-btn").click(function(){var b=a("li.ui-selected .thumbnail");if(b.length){if(multiSelect){useFiles(b)}else{useFile(b.first())}}else{alert(lang["error-file-empty"])}})});function forms_pd(a){if(!a){a="0"}a=a.toString();a=a.replaceAll(/1/g,"۱");a=a.replaceAll(/2/g,"۲");a=a.replaceAll(/3/g,"۳");a=a.replaceAll(/4/g,"۴");a=a.replaceAll(/5/g,"۵");a=a.replaceAll(/6/g,"۶");a=a.replaceAll(/7/g,"۷");a=a.replaceAll(/8/g,"۸");a=a.replaceAll(/9/g,"۹");a=a.replaceAll(/0/g,"۰");return a}function forms_digit_fa(d){return forms_pd(d);var e="";for(var b=0;b<d.length;b++){var c=d.charCodeAt(b);if(c>=48&&c<=57){var a=c+1584;e=e+String.fromCharCode(a)}else{e=e+String.fromCharCode(c)}}return e}function pd(a){return forms_digit_fa(a)}function selectFolder(b){var a=$(".breadcrumb-folders li.current");let parents=getFolderParents(b);let externalFields={};parents.each(function(){externalFields[$(this).attr("data-instance")]=$(this).attr("data-key")});$(".uploader-container").find("#externalFields").val(JSON.stringify(externalFields));$(".breadcrumb-folders .folder").removeClass("active");$(".folder .folder-icon").removeClass("fa-folder-open").addClass("fa-folder");$(".breadcrumb-folders li").removeClass("current");b.addClass("current");parents.addClass("active");$(".breadcrumb-folders .active").each(function(d){$(this).find("span.folder-icon").first().removeClass("fa-folder").addClass("fa-folder-open")});var c=new FormData();getListXhr=$.ajax({url:urls.getList+"/"+b.attr("data-instance")+"/"+b.attr("data-key"),beforeSend:function(){if(getListXhr&&getListXhr.readyState!=4){getListXhr.abort()}loadingDialog()},success:function(d){$("#thumbnail").html($(d));loadingDialog("hide");refreshSelection()}})}function refreshGallery(){selectFolder($(".breadcrumb-folders .folder.current"))}function refreshSelection(a){if(typeof seleted=="undefined"){a=$("li.ui-selected")}a=a.filter(function(b,c){let item=$(c);if(!item.length){return false}let img=item.find("img");if(!img.length){return false}if(img.hasClass("not-found")){item.removeClass("ui-selected");return false}return true});if(a.length){$("#add-btn").removeAttr("disabled")}else{$("#add-btn").attr("disabled","disabled")}let selectedClone=a.clone().removeAttr("class"),selectedCount=selectedClone.length,PersianCount=pd(selectedCount);footer.find(".attachments-preview").empty().append(selectedClone);footer.find(".count").empty().text("گزینش شده: "+PersianCount);$("#add-btn").val(selectedClone)}function switchToGallery(){tabs.filter("[data-page=gallery]").trigger("click")}function getFolderParents(b){var a=b.children("a");return a.parents(".folder")}function eachUploadCompleted(){refreshGallery()}function allUploadsCompleted(){setTimeout(switchToGallery,1000)}function getFileUrl(a){return $('[data-file="'+a+'"]').data("url")}function getFilePathname(a){return $('[data-file="'+a+'"]').data("pathname")}function getUrlParam(c){var b=new RegExp("(?:[?&]|&)"+c+"=([^&]+)","i");var a=window.location.search.match(b);return(a&&a.length>1)?a[1]:null}function showFileDetails(a){if(!a.is("li")){console.log("!li.is('li')");return false}if(!a.length){console.log("!li.length");return false}let thumb=a.find(".thumbnail");if(!thumb.length){console.log("!thumb.length");return false}let hashid=thumb.data("file");if(!hashid){return false}let thumbnail=$("ul.ui-selectable li .thumbnail[data-file="+hashid+"]");if(!thumbnail.length){console.log("!li.length");return false}let ul=thumbnail.closest("ul");if(!detailSidebar.is(":visible")){detailSidebar.show()}detailSidebar.find(".file-details").show();getFileDetailsXhr=$.ajax({url:urls.getFileDetails+"/"+hashid,beforeSend:function(){if(getFileDetailsXhr&&getFileDetailsXhr.readyState!=4){getFileDetailsXhr.abort()}},success:function(b){$(".file-details").attr("data-file",hashid);$(".file-details").html($(b));$(".setting :input").each(function(){let timerName=$(this).attr("name")+"-"+$.now();timers.fileDetails[timerName]=new Timer();$(this).attr("data-timer",timerName)})}});ul.find(".active").removeClass("active");thumbnail.closest("li").addClass("active")}function updateFileDetail(a){let file=a.closest(".file-details").attr("data-file");let inputName=a.attr("name");let inputValue=a.val();if(file&&(typeof inputName!=="undefined")&&(typeof inputValue!=="undefined")){let data={fileKey:file};let timerName=a.attr("data-timer");let timer=timers.fileDetails[timerName];inputValue=$.trim(inputValue);data[inputName]=inputValue;timer.delay(function(){$.ajax({url:urls.setFileDetails,type:"POST",data:data,beforeSend:function(){loadingDialog("show","#sidebar-loading")},complete:function(){loadingDialog("hide","#sidebar-loading")}})},1)}}function useFile(thumbEl){function useTinymce3(url){var win=tinyMCEPopup.getWindowArg("window");win.document.getElementById(tinyMCEPopup.getWindowArg("input")).value=url;if(typeof(win.ImageDialog)!="undefined"){if(win.ImageDialog.getImageData){win.ImageDialog.getImageData()}if(win.ImageDialog.showPreviewImage){win.ImageDialog.showPreviewImage(url)}}tinyMCEPopup.close()}function useTinymce4AndColorbox(url,field_name){parent.document.getElementById(field_name).value=url;if(typeof parent.tinyMCE!=="undefined"){parent.tinyMCE.activeEditor.windowManager.close()}if(typeof parent.$.fn.colorbox!=="undefined"){parent.$.fn.colorbox.close()}}function useCkeditor3(url){if(window.opener){window.opener.CKEDITOR.tools.callFunction(getUrlParam("CKEditorFuncNum"),url)}else{parent.CKEDITOR.tools.callFunction(getUrlParam("CKEditorFuncNum"),url);parent.CKEDITOR.tools.callFunction(getUrlParam("CKEditorCleanUpFuncNum"))}}function useFckeditor2(url){var p=url;var w=data.Properties["Width"];var h=data.Properties["Height"];window.opener.SetUrl(p,w,h)}function showFile(file){var preview=window.fileManagerModalOptions.preview;if(preview){$.ajax({url:route_preview,type:"post",data:{file:file},success:function(response){parent.document.getElementById(preview).innerHTML=response}})}}function useModal(result){let parentWindow=$(parent.document);let targetInput=parentWindow.find("#"+window.fileManagerModalOptions.input);if(targetInput.length){targetInput.val(result)}showFile(hashid);let callBackValue=window.fileManagerModalOptions.callback;if(callBackValue){parent.window.eval(callBackValue)}parent.window.closeFileManagerModal()}var hashid=thumbEl.data("file");var url=getFileUrl(hashid);var pathname=getFilePathname(hashid);var field_name=getUrlParam("field_name");var is_ckeditor=getUrlParam("CKEditor");var is_modal=window.fileManagerModalOptions.modal;var is_fcke=typeof data!="undefined"&&data.Properties["Width"]!="";var file_path=url.replace(route_prefix,"");var modal=url.replace(route_prefix,"");if(window.opener||window.tinyMCEPopup||field_name||getUrlParam("CKEditorCleanUpFuncNum")||is_ckeditor||is_modal){if(is_modal){switch(window.fileManagerModalOptions.outputType){case"hashid":useModal(hashid,field_name);break;case"url":useModal(url,field_name);break;default:useModal(pathname,field_name);break}}else{if(window.tinyMCEPopup){useTinymce3(url)}else{if(field_name){useTinymce4AndColorbox(url,field_name)}else{if(is_ckeditor){useCkeditor3(url)}else{if(is_fcke){useFckeditor2(url)}else{window.opener.SetUrl(url,file_path)}}}}}if(window.opener){window.close()}}else{window.opener.SetUrl(url,file_path)}}function useFiles(filesEls){function showFiles(hashids){var preview=window.fileManagerModalOptions.preview;if(preview){$.ajax({url:route_preview,type:"post",data:{file:hashids.join("-")},success:function(response){parent.document.getElementById(preview).innerHTML=response}})}}function useModal(result){let parentWindow=$(parent.document);let targetInput=parentWindow.find("#"+window.fileManagerModalOptions.input);if(targetInput.length){targetInput.val(JSON.stringify(result))}showFiles(hashids);let callBackValue=window.fileManagerModalOptions.callback;if(callBackValue){parent.window.eval(callBackValue)}parent.window.closeFileManagerModal()}var hashids=[];var is_modal=window.fileManagerModalOptions.modal;filesEls.each(function(){hashids.push($(this).data("file"))});if(is_modal){let result=[];switch(window.fileManagerModalOptions.outputType){case"hashid":result=hashids;break;case"url":filesEls.each(function(){result.push($(this).data("url"))});break;default:filesEls.each(function(){result.push($(this).data("pathname"))});break}useModal(result)}}function loadingDialog(b,a){if(isDefined(a)){if(!(a instanceof HTMLCollection)&&(typeof a=="string")){a=$(a)}}else{a=$("#loading-dialog")}if(a.length){if($.inArray(b,["hide",false,0])>-1){a.hide()}else{a.show()}}};