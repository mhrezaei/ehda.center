window.caseId=1;window.reactions=[];window.timers={};window.shockerCharge=0;window.currentData={};$(document).ready(function(){correctView();$.ajaxSetup({cache:false});lowLag.init({urlPrefix:siteUrl+"/assets/sound/"});lowLag.load(["heartSound.mp3","heartSound.ogg"],"pluck1");lowLag.load(["beep.mp3"],"beep");lowLag.load(["charging.mp3","charging.wav"],"charging");lowLag.load(["electricShock.mp3","electricShock.wav"],"electricShock");loadData();$(window).resize(function(){correctView()});$(".monitor-column-2").children().not(".monitor-case-management-panel").on("show",function(){correctManagementPanelHeight()}).on("hide",function(){correctManagementPanelHeight()});$(".pass-step").click(function(){var page=$(this).closest(".page");passStep(page)});$(".back-step").click(function(){var page=$(this).closest(".page");backStep(page)});$(".treatment-form").find(":input").change(function(){var that=$(this);var related=that.attr("data-relted");if(related){if(that.val()){$(related).closest(".form-group").show()}else{$(related).closest(".form-group").hide()}}});$(".treatment-form").on({click:function(event){event.preventDefault();var btn=$(this);var box=btn.closest(".treatment-form");var treatment=box.attr("data-treatment");var data=box.find(":input").serializeObject();if(!Object.values(data).includes("")){var equations=window.caseData.calculations;var toDo=eval("equations"+dash2brace(treatment));var doneActions=[];var beforeData=getValueOf(window.currentData);$.each(toDo,function(num,tasks){if(num){var checkingField=[treatment,num].join("-")}else{var checkingField=treatment}if(!$.isArray(data[checkingField])){data[checkingField]=[data[checkingField]]}$.each(tasks,function(val,targets){if($.inArray(val,data[checkingField])>-1){$.each(targets,function(targetName,equation){$.each(data,function(fieldName,fieldValue){equation=equation.replace(new RegExp("{{"+fieldName+"}}","g"),fieldValue)});var tmpAction={target:targetName,equation:equation,before:getValueOf(window.currentData)[targetName]};equation=equation.replace(new RegExp("{{orig}}","g"),window.currentData[targetName]);var result=eval(equation);setCaseData(targetName,Number(result.toFixed(2)));tmpAction.after=getValueOf(window.currentData)[targetName];tmpAction.change=tmpAction.after-tmpAction.before;doneActions.push(tmpAction)})}})});var lastReaction=window.reactions.last();var pushingNumber=window.reactions.push({fromStep:lastReaction.toStep,toStep:lastReaction.toStep,fromPage:lastReaction.toPage,toPage:lastReaction.toPage,forward:true,calculations:doneActions,beforeData:beforeData,afterData:getValueOf(window.currentData),treatment:treatment,treatmentData:data});btn.removeClass("btn-inject").addClass("btn-inject-remove");btn.attr("data-reaction",pushingNumber-1);btn.html("Remove");refreshScreen();if(!$(".second-preview").is(":visible")){$(".second-preview").show()}box.find(":input").attr("readonly","readonly");box.find(".form-group").css("pointer-events","none")}}},".btn-inject");$(".treatment-form").on({click:function(event){event.preventDefault();var btn=$(this);var box=btn.closest(".treatment-form");var reactionIndex=btn.attr("data-reaction");backStep(undefined,reactionIndex);btn.removeClass("btn-inject-remove").addClass("btn-inject");btn.removeAttr("data-reaction");btn.html("Apply");refreshScreen();box.find(":input").removeAttr("readonly","readonly");box.find(".form-group").css("pointer-events","auto")}},".btn-inject-remove");$(".monitor-ecg-shock-box").find(".btn-charge-shocker").unbind("click").bind("click",function(){var energy=$(".shocker-energy").val();chargeShocker(energy)});$(".monitor-ecg-shock-box").find(".btn-shock").unbind("click").bind("click",(function(){doShock()}));$(".show-case-info").click(function(){var btn=$(this);var target=btn.attr("data-page");showPage($(target));refreshScreen()})});function dash2brace(b){var c=b.split("-");var a="";$.each(c,function(d,e){a+="["+e+"]"});return a}function loadData(){loading();$.getJSON(siteUrl+"/files/ecg/json/cases.json",function(a){var b=a[window.caseId];window.caseData=b;setCaseData(b.defaultData);$(".case-biography").html(b.caseInfo.information);$(".case-height").html(b.caseInfo.height);$(".case-weight").html(b.caseInfo.weight);$(".case-urine-output").html(b.caseInfo.urineOutput);$(".case-more-information").html(b.caseInfo.moreInformation);$.each(b.exams,function(c,d){$.each(d,function(e,g){var f=["case",c,e].join(" ").title2kebab();$("."+f).html(g)})});refreshScreen();loading("hide")})}function loading(a){var b=$(".cover-page");if(typeof a!="undefined"||a=="hide"){b.fadeOut("slow")}else{b.fadeIn("slow")}}function passStep(page){var stepName=page.attr("data-step");window.tmpReaction={fromStep:stepName,fromPage:page,forward:true,done:false,beforeData:getValueOf(window.currentData),afterData:getValueOf(window.currentData)};var functionName="pass"+stepName+"Step";window[functionName](page);if(window.tmpReaction.done){delete window.tmpReaction.done;window.reactions.push(window.tmpReaction);eval(window.tmpReaction.toPage.attr("data-showing-action"));console.log(window.reactions)}}function passStartStep(){$("#start").removeClass("current");$("#start-question").addClass("current");window.tmpReaction.toStep=$("#start-question").attr("data-step");window.tmpReaction.toPage=$("#start-question");window.tmpReaction.done=true}function passStartQuestionStep(a){var c=$("input[type=radio][name=start-question]:checked").val();if(c){$("#start-question").removeClass("current");switch(c){case"1":var b=$("#more-info");b.addClass("current");window.tmpReaction.toStep=b.attr("data-step");window.tmpReaction.toPage=b;console.log(currentTime());break;case"2":var b=$("#laboratory-exams");b.addClass("current");window.tmpReaction.toStep=b.attr("data-step");window.tmpReaction.toPage=b;console.log(currentTime());break;case"3":var b=$("#treatment-modalities");b.addClass("current");window.tmpReaction.toStep=b.attr("data-step");window.tmpReaction.toPage=b;b.find("select").each(function(){$(this).val($(this).children("option").first().val())});break}window.tmpReaction.done=true}}function showPage(a){var b=$(".page.current");window.reactions.push({fromStep:b.attr("data-step"),fromPage:b,toStep:a.attr("data-step"),toPage:a,forward:true,done:false,beforeData:getValueOf(window.currentData),afterData:getValueOf(window.currentData)});b.removeClass("current");a.addClass("current")}function backStep(page,returningStepIndex){if(typeof returningStepIndex=="undefined"){returningStepIndex=window.reactions.length-1;var inverseColumn=window.reactions.getColumn("inverse");var lastStep=window.reactions[returningStepIndex];while(!lastStep.forward||(lastStep.auto&&window.reactions[returningStepIndex-1].auto)||($.inArray(returningStepIndex,inverseColumn)>-1)){returningStepIndex--;lastStep=window.reactions[returningStepIndex]}}else{var lastStep=window.reactions[returningStepIndex]}if(typeof page!="undefined"){var timeoutName=page.attr("timeout");if(timeoutName){clearTimeout(window.timers[timeoutName])}}if(lastStep.auto){var newData=getValueOf(lastStep.beforeData)}else{var newData={};$.each(lastStep.beforeData,function(key,value){var change=lastStep.afterData[key]-lastStep.beforeData[key];var result=getValueOf(window.currentData,key)-change;result=result.toFixed(2);result=Number(result);newData[key]=result})}setCaseData(newData);var newReaction={fromStep:getValueOf(lastStep,"toStep"),fromPage:lastStep.toPage,toStep:getValueOf(lastStep,"fromStep"),toPage:lastStep.fromPage,forward:false,inverse:returningStepIndex,beforeData:getValueOf(window.reactions.last().afterData),afterData:getValueOf(window.currentData)};newReaction.fromPage.removeClass("current");newReaction.toPage.addClass("current");if(window.reactionForceData&&$.isPlainObject(window.reactionForceData)){$.each(window.reactionForceData,function(key,value){newReaction[key]=value});delete window.reactionForceData}window.reactions.push(newReaction);eval(newReaction.toPage.attr("data-showing-action"));refreshScreen();return returningStepIndex}function pageTimeout(c,d,b){var a="timeout"+$.now();window.timers[a]=setTimeout(function(){if(c.hasClass("current")){b()}},d);c.attr("timeout",a)}function ventricularTachycardia(){console.log(currentTime()+" : VTach");var d={HR:210,SPO2:20,SBP:0,DBP:0,CVP:8};var a=[];var b=getValueOf(window.currentData);$(".monitor-ecg-preview-inner").addClass("VTach");$.each(d,function(e,f){a.push({before:getValueOf(window.currentData)[e],after:f,target:e})});setCaseData(d);var c=window.reactions.last();window.reactions.push({fromStep:c.toStep,toStep:c.toStep,fromPage:c.toPage,toPage:c.toPage,forward:true,auto:true,calculations:a,beforeData:c.afterData,afterData:getValueOf(window.currentData)});refreshScreen();$(".monitor-ecg-shock-box").find(".btn-shock").attr("disabled","disabled");$(".monitor-ecg-shock-box").show();$(".monitor-case-management-panel").hide();window.timers.die=setTimeout(kill,window.timeouts.VTack)}function refreshScreen(){$(".preview-bp").html(window.currentData.SBP+"/"+window.currentData.DBP);$(".preview-hr").html(window.currentData.HR);$(".preview-rr").html(window.currentData.RR);$(".preview-spo2").html(window.currentData.SPO2);$(".preview-cvp").html(window.currentData.CVP);$(".preview-temperature").html(window.currentData.T);$(".preview-uop").html(window.currentData.UOP);$(".preview-hgb").html(window.currentData.Hgb);$(".preview-inr").html(window.currentData.INR);$(".preview-bs").html(window.currentData.BS);$(".preview-na").html(window.currentData.Na);$(".preview-k").html(window.currentData.K);$(".preview-ca").html(window.currentData.Ca);$(".preview-ph").html(window.currentData.PH);$(".preview-pco2").html(window.currentData.PCO2);$(".preview-hco3").html(window.currentData.HCO3);$(".preview-po2").html(window.currentData.PO2);$(".preview-albumin").html(window.currentData.Albumin);runECG(window.currentData.HR);playHeartSound(window.currentData.HR);if($("#more-info").hasClass("current")||$("#laboratory-exams").hasClass("current")){$(".case-info-buttons").hide()}else{if(!$(".case-info-buttons").is(":visible")){$(".case-info-buttons").show()}}}function runECG(c){stopECG();var a=$(".monitor-ecg-preview-inner");var b=a.css("background-image").match(/^url\("?(.+?)"?\)$/);if(b[1]){b=b[1];image=new Image();$(image).on("load",function(){var d=(image.width*a.height())/image.height/40;runECGPeriod(c,d);window.timers.ecgMotion=setInterval(function(){runECGPeriod(c,d)},60000)});image.src=b}}function runECGPeriod(b,a){$(".monitor-ecg-preview-inner").animate({"background-position-x":"-="+(b*a)+"px"},60000,"linear")}function stopECG(a){clearInterval(window.timers.ecgMotion);$(".monitor-ecg-preview-inner").stop();delete window.timers.ecgMotion}function chargeShocker(c){console.log("----------------------------------------charge start------------------------------------------");var b=100;var a=$(".shocker-charger-box");var d=a.find(".progress-bar");var e=(c/b)*2000;playSound("charging");a.css("opacity",1);d.animate({width:"100%"},e,function(){$(".monitor-ecg-shock-box").find(".btn-shock").removeAttr("disabled");window.shockerCharge=c;d.attr("aria-valuenow",100);$(".btn-charge-shocker").hide();$(".btn-shock").show();console.log("----------------------------------------charge finished------------------------------------------")})}function doShock(){console.log("----------------------------------------doShock------------------------------------------");$(".monitor-ecg-preview-inner").removeClass("VTach").removeClass("dead");$(".shocker-charger-box").css("opacity",0);$(".shocker-charger-box").find(".progress-bar").css("width","0").attr("aria-valuenow",0);if(true){playSound("shock");clearTimeout(window.timers.die);delete window.timers.die;backStep();delete window.reactionForceData;$(".monitor-case-management-panel").show();$(".monitor-ecg-shock-box").hide();$(".btn-charge-shocker").show();$(".btn-shock").hide();window.shockerCharge=0}}function currentTime(){var a=new Date();return a.getHours()+":"+a.getMinutes()+":"+a.getSeconds()}function kill(){console.log(currentTime()+" : die");var d={HR:0,SPO2:20,SBP:0,DBP:0,CVP:8};var a=[];var b=getValueOf(window.currentData);$(".monitor-ecg-preview-inner").removeClass("VTach").addClass("dead");$.each(d,function(e,f){a.push({before:getValueOf(window.currentData)[e],after:f,target:e})});setCaseData(d);var c=window.reactions.last();window.reactions.push({fromStep:c.toStep,toStep:c.toStep,fromPage:c.toPage,toPage:c.toPage,forward:true,auto:true,calculations:a,beforeData:b,afterData:getValueOf(window.currentData)});refreshScreen();$(".monitor-ecg-shock-box").find(".btn-shock").attr("disabled","disabled");$(".monitor-ecg-shock-box").show();$(".monitor-case-management-panel").hide()}function getValueOf(b,a){var b=JSON.parse(JSON.stringify(b));if(typeof a!="undefined"){return b[a]}return b}function playHeartSound(c){if(c){var a=(60*1000)/c;var b="heartSound"}else{var a=200;var b="beep"}stopHeartSound();window.timers.soundHR=setInterval(function(){playSound(b)},a)}function stopHeartSound(){if(typeof window.timers.soundHR!="undefined"){clearInterval(window.timers.soundHR);delete window.timers.soundHR}}function playSound(a){if(!window.optionsStatuses.playSound){return}switch(a){case"heartSound":lowLag.play("pluck1",false);break;case"charging":lowLag.play("charging",false);break;case"shock":lowLag.play("electricShock",false);break;case"beep":lowLag.play("beep",false);break;case"wrong":boing.play();break;case"right":right1.play();break;case"wellDone":wellDone.play();break;case"helpMe":helpMe.play();break;case"congrats":congrats.play();break}}function setCaseData(b,a){if($.isPlainObject(b)){$.each(b,function(c,d){setCaseData(c,d)})}else{if(b=="SPO2"){a=Math.min(a,100)}window.currentData[b]=a}}function doneTreatments(){var b=window.reactions.getColumn("inverse");var a=[];$.each(window.reactions,function(c,d){if(d.treatment&&($.inArray(c.toString(),b)==-1)){a.push(d.treatment)}});return a}function needToFIO2(){if(!checkFIO2()){setTimeout(function(){if(!checkFIO2()){ventricularTachycardia()}},window.timeouts.needToFIO2)}}function checkFIO2(){var b="3-1";var a=doneTreatments();if($.inArray(b,a)>-1){return true}}function correctView(){correctBodyHeight();correctVitalSingsHeight();correctManagementPanelHeight()}function correctBodyHeight(){var b=$("body").height();var a=$(".container-main").height();if(a>b){$("body").height(a)}else{$("body").height("")}}function correctVitalSingsHeight(){var a=$(".monitor-vital-sign");var d=a.first();var b=$(".monitor-column-1").height();var f=(b/a.length)-2;var e=f-d.find(".monitor-vital-sign-heading").height()-parseInt(d.find(".monitor-vital-sign-value").css("padding-top"));var c=e/window.styleConstants.line_height;a.find(".monitor-vital-sign-value").css("font-size",c+"px")}function correctManagementPanelHeight(){var b=$(".monitor-case-management-panel");var j=b.siblings(":visible");var i=$(".monitor-column-2").height();var e=0;j.each(function(){var m=$(this);e+=(m.outerHeight()+parseInt(m.css("margin-top"))+parseInt(m.css("margin-bottom")))});var d=i-e;var h=d-(parseInt(b.css("margin-top"))+parseInt(b.css("margin-bottom")));b.height(h);var a=b.find("#treatment-modalities.page");var g=false;if(!a.is(":visible")){g=true}if(a.length){var c=a.find(".nav");if(g){var f=a.attr("style");a.css({visibility:"hidden",display:"block"})}var k=c.outerHeight();if(g){a.attr("style",f?f:"")}var l=h-k-2;a.find(".tab-content").height(l)}}function resetShocker(){console.log(currentTime()+" : resetShocker");window.shockerCharge=0;var d=$(".monitor-ecg-shock-box");var b=d.find(".shocker-charger-box");var c=b.find(".progress-bar");var a=d.find(".shocker-energy");a.val(a.find("option").first().val());c.css("width",0);c.attr("aria-valuenow",100);$(".btn-charge-shocker").show();$(".btn-shock").hide().attr("disabled","disabled")}function showShocker(){$(".monitor-ecg-shock-box").show()}function turnShockerOff(){$(".monitor-ecg-shock-box").hide();resetShocker()};