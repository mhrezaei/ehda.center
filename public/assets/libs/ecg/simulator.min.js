window.caseId=1;window.reactions=[];window.timers={};window.shockerCharge=0;window.currentData={};window.optionsStatuses={playSound:true};$(document).ready(function(){$.ajaxSetup({cache:false});lowLag.init({urlPrefix:siteUrl+"/assets/sound/"});lowLag.load(["heartSound.mp3","heartSound.ogg"],"pluck1");lowLag.load(["beep.mp3"],"beep");fixBodyHeight();loadData();$(window).resize(function(){fixBodyHeight()});$(".pass-step").click(function(){var page=$(this).closest(".page");passStep(page)});$(".back-step").click(function(){var page=$(this).closest(".page");backStep(page)});$(".treatment-form").find(":input").change(function(){var that=$(this);var related=that.attr("data-relted");if(related){if(that.val()){$(related).closest(".form-group").show()}else{$(related).closest(".form-group").hide()}}});$(".treatment-form").find(".btn-inject").click(function(event){event.preventDefault();var btn=$(this);var box=btn.closest(".treatment-form");var treatment=box.attr("data-treatment");var data=box.find(":input").serializeObject();if(!Object.values(data).includes("")){var equations=window.caseData.calculations;var toDo=eval("equations"+dash2brace(treatment));var doneActions=[];var beforeData=getValueOf(window.currentData);$.each(toDo,function(num,tasks){if(num){var checkingField=[treatment,num].join("-")}else{var checkingField=treatment}if(!$.isArray(data[checkingField])){data[checkingField]=[data[checkingField]]}$.each(tasks,function(val,targets){if($.inArray(val,data[checkingField])>-1){$.each(targets,function(targetName,equation){$.each(data,function(fieldName,fieldValue){equation=equation.replace(new RegExp("{{"+fieldName+"}}","g"),fieldValue)});var tmpAction={target:targetName,equation:equation,before:getValueOf(window.currentData)[targetName]};equation=equation.replace(new RegExp("{{orig}}","g"),window.currentData[targetName]);var result=eval(equation);setCaseData(targetName,Number(result.toFixed(2)));tmpAction.after=getValueOf(window.currentData)[targetName];doneActions.push(tmpAction)})}})});var lastReaction=window.reactions.last();window.reactions.push({fromStep:lastReaction.toStep,toStep:lastReaction.toStep,fromPage:lastReaction.toPage,toPage:lastReaction.toPage,forward:true,calculations:doneActions,beforeData:beforeData,afterData:getValueOf(window.currentData),treatment:treatment,treatmentData:data});refreshScreen();if(!$(".second-preview").is(":visible")){$(".second-preview").slideDown()}btn.hide()}});$(".monitor-ecg-shock-box").find(".btn-charge-shocker").click(function(){var energy=$(".shocker-energy").val();chargeShocker(energy)});$(".monitor-ecg-shock-box").find(".btn-shock").click(function(){doShock()});$(".show-case-info").click(function(){var btn=$(this);var target=btn.attr("data-page");showPage($(target));refreshScreen()})});function fixBodyHeight(){var b=$("body").height();var a=$(".container-main").height();if(a>b){$("body").height(a)}else{$("body").height("")}}function dash2brace(b){var c=b.split("-");var a="";$.each(c,function(d,e){a+="["+e+"]"});return a}function loadData(){loading();$.getJSON(siteUrl+"/files/ecg/json/cases.json",function(a){var b=a[window.caseId];window.caseData=b;setCaseData(b.defaultData);$(".case-biography").html(b.caseInfo.information);$(".case-height").html(b.caseInfo.height);$(".case-weight").html(b.caseInfo.weight);$(".case-urine-output").html(b.caseInfo.urineOutput);$(".case-more-information").html(b.caseInfo.moreInformation);$.each(b.exams,function(c,d){$.each(d,function(e,g){var f=["case",c,e].join(" ").title2kebab();$("."+f).html(g)})});refreshScreen();loading("hide")})}function loading(a){var b=$(".cover-page");if(typeof a!="undefined"||a=="hide"){b.fadeOut("slow")}else{b.fadeIn("slow")}}function passStep(b){var c=b.attr("data-step");window.tmpReaction={fromStep:c,fromPage:b,forward:true,done:false,beforeData:getValueOf(window.currentData),afterData:getValueOf(window.currentData)};var a="pass"+c+"Step";window[a](b);if(window.tmpReaction.done){delete window.tmpReaction.done;window.reactions.push(window.tmpReaction);console.log(window.reactions)}}function passStartStep(){$("#start").removeClass("current");$("#start-question").addClass("current");window.tmpReaction.toStep=$("#start-question").attr("data-step");window.tmpReaction.toPage=$("#start-question");window.tmpReaction.done=true}function passStartQuestionStep(a){var c=$("input[type=radio][name=start-question]:checked").val();if(c){$("#start-question").removeClass("current");switch(c){case"1":var b=$("#more-info");b.addClass("current");window.tmpReaction.toStep=b.attr("data-step");window.tmpReaction.toPage=b;console.log(currentTime());pageTimeout($("#more-info"),20*1000,ventricularTachycardia);break;case"2":var b=$("#laboratory-exams");b.addClass("current");window.tmpReaction.toStep=b.attr("data-step");window.tmpReaction.toPage=b;console.log(currentTime());pageTimeout($("#laboratory-exams"),40*1000,ventricularTachycardia);break;case"3":var b=$("#treatment-modalities");b.addClass("current");window.tmpReaction.toStep=b.attr("data-step");window.tmpReaction.toPage=b;b.find("select").each(function(){$(this).val($(this).children("option").first().val())});setTimeout(function(){var e="3-1";var d=doneTreatments();if($.inArray(e,d)==-1){ventricularTachycardia()}},60*1000);break}window.tmpReaction.done=true}}function showPage(a){var b=$(".page.current");window.reactions.push({fromStep:b.attr("data-step"),fromPage:b,toStep:a.attr("data-step"),toPage:a,forward:true,done:false,beforeData:getValueOf(window.currentData),afterData:getValueOf(window.currentData)});b.removeClass("current");a.addClass("current")}function backStep(e,d){if(typeof d=="undefined"){d=window.reactions.length-1;var c=window.reactions[d];console.log(c);while(!c.forward||c.auto){d--;c=window.reactions[d]}console.log(c)}else{var c=window.reactions[d]}if(typeof e!="undefined"){var a=e.attr("timeout");if(a){clearTimeout(window.timers[a])}}setCaseData(c.beforeData);var b={fromStep:c.toStep,fromPage:c.toPage,toStep:c.fromStep,toPage:c.fromPage,forward:false,inverse:d,beforeData:c.afterData,afterData:getValueOf(window.currentData)};b.fromPage.removeClass("current");b.toPage.addClass("current");window.reactions.push(b);refreshScreen()}function pageTimeout(c,d,b){var a="timeout"+$.now();window.timers[a]=setTimeout(function(){if(c.hasClass("current")){b()}},d);c.attr("timeout",a)}function ventricularTachycardia(){console.log("VTach");console.log(currentTime());var d={HR:210,SPO2:20,SBP:0,DBP:0,CVP:8};var a=[];var b=getValueOf(window.currentData);$(".monitor-ecg-preview-inner").addClass("VTach");$.each(d,function(e,f){a.push({before:getValueOf(window.currentData)[e],after:f,target:e})});setCaseData(d);var c=window.reactions.last();window.reactions.push({fromStep:c.toStep,toStep:c.toStep,fromPage:c.toPage,toPage:c.toPage,forward:true,auto:true,calculations:a,beforeData:b,afterData:getValueOf(window.currentData)});refreshScreen();$(".monitor-ecg-shock-box").find(".btn-shock").attr("disabled","disabled");$(".monitor-ecg-shock-box").show();$(".monitor-case-management-panel").hide();window.timers.die=setTimeout(kill,60*1000)}function refreshScreen(){$(".preview-bp").html(window.currentData.SBP+"/"+window.currentData.DBP);$(".preview-hr").html(window.currentData.HR);$(".preview-rr").html(window.currentData.RR);$(".preview-spo2").html(window.currentData.SPO2);$(".preview-cvp").html(window.currentData.CVP);$(".preview-temperature").html(window.currentData.T);$(".preview-uop").html(window.currentData.UOP);$(".preview-hgb").html(window.currentData.HgB);$(".preview-inr").html(window.currentData.INR);$(".preview-bs").html(window.currentData.BS);$(".preview-na").html(window.currentData.Na);$(".preview-k").html(window.currentData.K);$(".preview-ca").html(window.currentData.Ca);$(".preview-ph").html(window.currentData.PH);$(".preview-pco2").html(window.currentData.PCO2);$(".preview-hco3").html(window.currentData.HCO3);$(".preview-po2").html(window.currentData.PO2);$(".preview-albumin").html(window.currentData.Albumin);runECG(window.currentData.HR);playHeartSound(window.currentData.HR);if($("#more-info").hasClass("current")||$("#laboratory-exams").hasClass("current")){$(".case-info-buttons").hide()}else{if(!$(".case-info-buttons").is(":visible")){$(".case-info-buttons").show()}}}function runECG(c){stopECG();var a=$(".monitor-ecg-preview-inner");var b=a.css("background-image").match(/^url\("?(.+?)"?\)$/);if(b[1]){b=b[1];image=new Image();$(image).on("load",function(){var d=(image.width*a.height())/image.height/20;runECGPeriod(c,d);window.timers.ecgMotion=setInterval(function(){runECGPeriod(c,d)},60000)});image.src=b}}function runECGPeriod(b,a){$(".monitor-ecg-preview-inner").animate({"background-position-x":"-="+(b*a)+"px"},60000,"linear")}function stopECG(a){clearInterval(window.timers.ecgMotion);$(".monitor-ecg-preview-inner").stop();delete window.timers.ecgMotion}function chargeShocker(c){var b=100;var a=$(".shocker-charger-box");var d=a.find(".progress-bar");var e=(c/b)*1000;a.css("opacity",1);d.animate({width:"100%"},e,function(){$(".monitor-ecg-shock-box").find(".btn-shock").removeAttr("disabled");window.shockerCharge=c;d.attr("aria-valuenow",100)})}function doShock(){$(".monitor-ecg-preview-inner").removeClass("VTach").removeClass("dead");$(".shocker-charger-box").css("opacity",0);$(".shocker-charger-box").find(".progress-bar").css("width","0").attr("aria-valuenow",0);if(true){clearTimeout(window.timers.die);delete window.timers.die;backStep();$(".monitor-case-management-panel").show();$(".monitor-ecg-shock-box").hide()}}function currentTime(){var a=new Date();return a.getHours()+":"+a.getMinutes()+":"+a.getSeconds()}function kill(){console.log("die");console.log(currentTime());var d={HR:0,SPO2:20,SBP:0,DBP:0,CVP:8};var a=[];var b=getValueOf(window.currentData);console.log("beforeData");console.log(b);$(".monitor-ecg-preview-inner").removeClass("VTach").addClass("dead");$.each(d,function(e,f){a.push({before:getValueOf(window.currentData)[e],after:f,target:e})});setCaseData(d);var c=window.reactions.last();window.reactions.push({fromStep:c.toStep,toStep:c.toStep,fromPage:c.toPage,toPage:c.toPage,forward:true,auto:true,calculations:a,beforeData:b,afterData:getValueOf(window.currentData)});refreshScreen();$(".monitor-ecg-shock-box").find(".btn-shock").attr("disabled","disabled");$(".monitor-ecg-shock-box").show();$(".monitor-case-management-panel").hide()}function getValueOf(b,a){var b=JSON.parse(JSON.stringify(b));if(typeof a!="undefined"){return b[a]}return b}function playHeartSound(c){if(c){var a=(60*1000)/c;var b="heartSound"}else{var a=200;var b="beep"}stopHeartSound();window.timers.soundHR=setInterval(function(){playSound(b)},a)}function stopHeartSound(){if(typeof window.timers.soundHR!="undefined"){clearInterval(window.timers.soundHR);delete window.timers.soundHR}}function playSound(a){if(!window.optionsStatuses.playSound){return}switch(a){case"heartSound":lowLag.play("pluck1",false);break;case"beep":lowLag.play("beep",false);break;case"wrong":boing.play();break;case"right":right1.play();break;case"wellDone":wellDone.play();break;case"helpMe":helpMe.play();break;case"congrats":congrats.play();break}}function setCaseData(b,a){if($.isPlainObject(b)){$.each(b,function(c,d){setCaseData(c,d)})}else{if(b=="SPO2"){a=Math.min(a,100)}window.currentData[b]=a}}function doneTreatments(){return $.map(window.reactions,function(a){return a.treatment})};